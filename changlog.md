# Murasaki Translator - Changelog

## [1.1.3] - 2026-01-27

### 字幕与结构化文档增强 (Subtitle & Structured Docs)
- **ASS/SSA 字幕支持**:
    - **原生解析**: 新增 `AssDocument` 处理器，能够解析 `[Events]` 块并提取时间轴。
    - **上下文注入**: 自动提取 `Actor`（角色）和 `Style`（样式）信息，并将其作为上下文前缀注入 Prompt，辅助模型识别说话人语气。
    - **无损重构**: 翻译后能够精确回填至原始 ASS 模板，保留所有特效标签和头部元数据。
- **SRT 结构化透传 (Structural Pass-through)**:
    - 重构了 SRT 处理逻辑。不再单纯提取文本，而是将序号、时间轴和文本作为一个整体块传给模型。这极大地提升了模型对语境节奏的理解能力。
- **严格对齐模式 (Strict Mode)**:
    - **三级策略**: 引入 `Off` (关闭) / `Subs` (仅字幕) / `All` (强制开启) 三种模式。
    - **强校验**: 在严格模式下，如果输出行数与输入不完全一致（容差为 0），将直接触发重试。这有效防止了字幕错位问题。

### 核心逻辑修复与优化 (Core & Middleware)
- **规则熔断机制 (Rule Melting)**:
    - 针对字幕文件（SRT/ASS），系统现在会自动禁用 `clean_empty_lines`（空行清理）和 `merge_short_lines`（短行合并）等可能改变行数的后处理规则，确保结构安全。
- **文本保护器增强 (TextProtector Hardening)**:
    - **模糊还原算法**: 引入了针对 LLM "幻觉"的模糊匹配逻辑。即使模型在占位符中插入了空格（如 `@ 1 @`）或将其转换为全角字符，系统也能正确还原原文。
    - **ASS 激进清洗**: 针对 ASS 格式启用了激进的空格清洗策略，防止保护标签周围产生的多余空格破坏排版。
- **Windows 文件锁修复**:
    - 修复了在 Windows 环境下，文档重构保存时因文件句柄未释放导致的 `PermissionError` 或 0KB 文件问题。
- **规则引擎修复**:
    - 修正了 `clean_empty` 与 `clean_empty_lines` 的命名不一致问题，确保 TXT 文档的空行清理功能正常生效。
    - 恢复了缺失的 `merge_short_lines` 逻辑，提升碎片化文本的整理能力。

### 界面优化 (GUI)
- **高级设置调整**:
    - 新增“严格对齐模式”下拉菜单。
    - 移除了设置页面中冗余且为空的“实验性功能”区块，保持界面整洁。
- **格式过滤器**: 文件选择对话框现在正式支持 `.ass` 和 `.ssa` 扩展名。

---

## [1.1.2] - 2026-01-27

### 续传逻辑重构与重复修复 (Resume Logic Refactor)
- **GUI**: 删除了高级设置中的“增量翻译”开关。现在统一由文件检测逻辑驱动，操作更简便。
- **Middleware**: 修复了追加模式下可能导致输出内容重复写入的 Bug。
- **Middleware**: 优化了 `calculate_skip_blocks` 算法，采用精确行数判定，确保续传时的数据完整性。
- **Middleware**: 修正了从现有文件启动翻译时的进度计数逻辑，现在初始进度显示更加准确。

---

## [1.1.1] - 2026-01-27

###  核心架构重构 (Core Architecture)
- **文档处理管道抽象化**: 引入 `DocumentFactory` 体系，支持多种格式的智能解析与回填。
    - **新增 EPUB 支持**: 原生支持电子书格式，解析 HTML 结构并自动剥离 Ruby 注音，翻译后精准回填。
    - **新增 SRT 支持**: 支持字幕文件，完美保留时间戳元数据。
    - **统一加载逻辑**: 所有文档格式现在都通过统一的项（Item）和元数据（Metadata）流程处理。
- **规则引擎一体化**: 彻底废除硬编码的文本修复开关。
    - 原有的注音清理、标点修复、假名修复、繁体转换全部整合进 `RuleProcessor` 插件系统。
    - 支持**严格行数模式 (Strict Line Count)**：针对 EPUB/SRT 自动禁用会改变行数的规则，确保翻译不串行。
- **智能元数据分块**: `Chunker` 现在能够携带元数据，并根据文档类型自动调整切分策略（如结构化文档自动禁用尾部平衡）。

###  新增功能 (Features)
- **Python 驱动规则沙盒**: 
    - 弃用前端 JS 模拟正则，改由真实的 Python 后端驱动测试。
    - **阶梯式追踪**: 可视化展示每一条规则对文本产生的增量修改，确保“所见即所得”。
- **可视化规则编辑器**: 
    - 移除分散的配置项，整合为统一的拖拽式编辑器。
    - 新增 10+ 种内置算法预设（内置处理器），涵盖排版优化、字符修复及实验性假名清理。
- **动态保护系统**: `TextProtector` 现在支持多规则聚合，可根据用户定义的规则自动激活多个不变量保护标签。

###  修复与优化 (Fixes & Optimization)
- **Windows 兼容性强化**: 
    - 为所有 Python 子进程强制开启 `PYTHONIOENCODING=utf-8`。
    - 解决了 Windows 环境下非 ASCII 路径和字符导致的进程崩溃。
- **断点续传 (Resume) 增强**:
    - 针对 EPUB/SRT 实现了**内存状态重建**：续传时自动从现有输出提取译文，确保重构文档时的结构完整性。
    - **TXT 续传安全性修复**: 彻底解决了 TXT 续传可能导致的行偏移风险 (Offset Drift)。TX 模式现在跳过内存重建，直接使用流式追加且不再进行最终覆盖保存，确保 100% 数据完整性。
- **术语表 (Glossary) 日志**: 详细记录术语命中详情及跳过原因，便于调试术语库覆盖率。
- **依赖更新**: 新增 `beautifulsoup4` 和 `lxml` 支持，增强 HTML/EPUB 解析稳定性。

---

## [1.1.0] - 2026-01-26

### Added
- **并行翻译引擎 (Parallel Translation Engine)**：引入多线程架构，支持最高 16 个并发任务。通过同时处理多个文本块，最大化高端硬件（如 RTX 3090/4090）的 GPU 利用率。
- **推理质量控制 (Quality Control)**：在高级视图（AdvancedView）中添加了细粒度的推理参数控制：
    - **Flash Attention (-fa)**：优化显存占用，提高长上下文稳定性（需 RTX 20 系列及以上显卡）。
    - **KV Cache 量化**：可配置缓存精度（F16, Q8_0, Q4_0），平衡翻译质量与显存容量。
    - **物理批处理同步 (Physical Batch Sync)**：强制执行 `batch_size = ubatch_size` 逻辑，并根据并发数自动缩放，确保处理逻辑的一致性。
    - **种子锁定 (Seed Locking)**：支持固定随机种子，以实现可重复的翻译结果。
- **末端平衡策略 (Tail Balancing Strategy)**：实现智能分块算法，自动检测最后一个文本块是否过短（如少于目标的 30%）。系统会自动合并并重新分配最后 3-5 个块，确保上下文长度均匀。
- **断点续传系统 (Resumability System)**：添加了基于 `.temp.jsonl` 文件的鲁棒颗粒度恢复功能。翻译可以从精确的中断块恢复，并受配置指纹检查保护，防止上下文损坏。
- **UI 可视化增强**：
    - 在高级设置中添加了 **上下文/显存热力图 (Context/VRAM Heatmap)**，直观展示内存压力。
    - 添加了 **系统顾问面板 (System Advisory panel)**，针对架构限制（32k token 上限）和效率瓶颈提供警告。
- **线程安全日志 (Thread-Safe Logging)**：为标准输出实现全局锁，防止并行处理期间 JSON 日志交织错乱。

### Changed
- **服务器架构**：`ServerManager` 现在会动态计算总上下文池大小（单槽上下文 * 并发数），并将其限制在 32k token 以内，防止引擎崩溃。
- **仪表盘逻辑**：重构了计时器和进度计算，支持非线性并行完成。添加了“平滑 ETA”逻辑，提供更准确的预计剩余时间。
- **缩进保留**：更新 `parser.py` 和 `rule_processor.py`，使用 `rstrip()` 替代 `strip()`，以保留 CJK 小说中常见的段落缩进。
- **循环检测**：优化了重复检查守护程序，将轻小说中常见的风格化重复（如 ……, —, ！）列入白名单，减少误报重试。
- **引擎核心**：`InferenceEngine` 切换至使用 `requests.Session` 保持持久连接，减少高并发场景下的 TCP 开销。

### Fixed
- **上下文处理**：修复了上下文溢出可能静默发生的问题；系统现在会显式警告并截断上下文窗口。
- **流式解析**：添加了针对未闭合 `<think>` 标签的正则支持，确保即使模型输出被截断也能捕获思维链（CoT）内容。

---

## [1.0.5] - 2026-01-26

### Added
- **纯 CPU 模式支持**：增强 `get_specs.py` 的系统内存检测与优雅回退逻辑，确保在没有 NVIDIA GPU 或 CUDA 驱动的机器上也能正常加载 GUI。
- **硬件鲁棒性**：对 `pynvml` 和 `nvidia-smi` 调用添加了健壮的异常处理，防止在驱动缺失时启动崩溃。

### Changed
- **省略号规则优化**：更新 `ellipsis` 规则，仅标准化 3 个或更多字符的序列（如 `...` 或 `。。。`），确保双句号（`。。`）得以保留。
- **引号配对安全**：为 `smart_quotes` 规则实现了 **偶数校验 (Even-count parity check)**（同步至 TS/Python）。单行直引号仅在成对出现时才会转换，有效防止由于符号缺失导致的格式“漂移”。

---

## [1.0.4] - 2026-01-26

### Added
- **默认后处理设置**：将“强制双换行”和“统一引号”设为初始启动和系统重置时的默认规则。
- **省略号规则**：新增内置格式化规则（需手动选择），可将各种形式的省略号统一为 `……`。
- **后端一致性**：完成 Python 端 `rule_processor.py` 与前端逻辑的同步，确保翻译过程中的一致性。

### Changed
- **预设优化**：精炼了“小说”和“通用”预设以确保最佳间距，将新的省略号规则保留为可选手动项。
- **鲁棒引号配对**：增强 `smart_quotes` 规则，加入单行偶数验证机制，仅在成对时将直引号（`"`、`'`）安全转换为角引号。
- **代码质量**：在标点符号映射中将不稳定的 `any` 类型替换为严格的 TypeScript Records。
- **重置逻辑**：将规则编辑器的全局重置提示替换为局部的确认对话框，并通过 `DEFAULT_POST_RULES` 常量集中定义默认规则。

### Fixed
- **智能引号逻辑**：统一前后端 `smart_quotes` 逻辑，严格转换至日/中式角引号 「」『』。
- **重置重复问题**：修复了重置规则时偶尔会产生重复条目的 Bug。
- **版本同步**：解决了 `package-lock.json` 与主项目版本不一致的问题。

---

## [1.0.3] - 2026-01-26

### Added
- **完整本地化**：实现了 `AdvancedView`、`ProofreadView` 和 `RuleEditor` 在中、英、日三语下的 100% 本地化覆盖。
- **结构完整性**：修复了 `i18n.ts` 中缺失的翻译键值和 JSON 结构错误，防止运行时崩溃。

### Changed
- **UI/UX 优化**：调整了 `GlossaryConverter` 的布局，将关键提示移至顶部以提高可见性。
- **代码审计**：完成了最终的 i18n 审计，消除了残留的硬编码字符串，确保各语言块键值一致。

### Fixed
- **语法错误**：修复了语言配置文件中残留的语法问题（如缺失逗号）。

---

## [1.0.2] - 2026-01-26

### Added
- **i18n 支持**：为术语表（Glossary）系统实现了全面的国际化支持（中/英/日）。
- **术语转换器 UI**：添加了一个完全本地化的可视化界面，用于将旧版文本术语表转换为标准 Murasaki JSON 格式。

### Changed
- **UI 清晰度**：改进了旧版术语格式的提示和指示器，方便用户理解格式转换的好处。
- **软件更新 UI**：重构了设置中的更新检查界面，采用更紧凑的布局和 LED 风格的状态指示灯，并改为仅手动触发以防止 API 速率限制。
- **版本统一管理**：集中化版本控制，所有 UI 组件现在动态引用来自 `package.json` 的 `APP_CONFIG.version`。

### Fixed
- **硬编码消除**：消除了 `GlossaryView.tsx` 和 `GlossaryConverter.tsx` 中剩余的所有硬编码中文，确保一致的本地化体验。

---

## [1.0.1] - 2026-01-26

### Fixed
- **UI 溢出**：修复了质量检查（Quality Check）结果面板在条目较多时不滚动的 Bug。
- **链接处理**：将 `window.open` 替换为带有 **协议验证 (http/https)** 的 `shell.openExternal` 以增强安全性。
- **更新检查**：为 GitHub API 调用添加了 HTTP 200 状态验证，防止解析错误。
- **IPC 可靠性**：修复了 `TypeError: window.api.invoke is not a function`，通过在预加载桥接中显式暴露 `checkUpdate` 解决。

### Added
- **更新系统**：实现了具有 **语义化版本比较 (Semantic Versioning)** 和网络提示的简易更新检查机制。
- **开发工具**：添加了 `dev_start.bat` 用于简化本地环境搭建。
- **Git 配置**：更新 `.gitignore`，包含开发脚本和私有变更日志。

### Changed
- **版本提升**：在 `package.json` 和内部配置中将应用版本提升至 1.0.1。